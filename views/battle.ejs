<%- include('./common/header') %>

<script type="text/javascript" src="javascripts/common.js"></script>
<script type="text/javascript" src="javascripts/game.js"></script>
<script type="text/javascript" src="javascripts/piece.js"></script>
<script type="text/javascript" src="javascripts/board.js"></script>
<script type="text/javascript" src="javascripts/komaAction.js"></script>
<link rel='stylesheet' href='/stylesheets/board.css' />
<link rel='stylesheet' href='/stylesheets/modal.css' />

<script src='/socket.io/socket.io.js'></script>
<script>
  // クリックorタップできる方を判定
  let clickEventType=((window.ontouchstart!==null)?'click':'touchstart');

  // socket通信開始
  let socket = io('/battle');

  // 対局情報を詰めておく
  let game = new Game();
  game.ownId    = <%=own.id%>;
  game.roomId   = <%=matchingInfo.roomId%>;
  game.isSente  = <%=matchingInfo.sente%>;
  game.isGote   = <%=matchingInfo.gote%>;

  // 初期盤面配置
  let board = <%- JSON.stringify(boardInfo) %>;

  // 手番情報
  let teban = <%=matchingInfo.sente == own.id%> ? true: false;

  $(document).ready(function(){

    // モーダル表示
    $('#modal-container').removeAttr('class').addClass('match');
    $('body').addClass('modal-active');
    setTimeout(function(){
      $('#modal-container').addClass('out');
      $('body').removeClass('modal-active');
    },3000);

    // 部屋に入室
    socket.emit("joinBattle", "<%=matchingInfo.roomId%>");

    // 駒画像初期表示
    dispInitKomaImg();

    // 盤面更新
    socket.on("updateBoard", function (data) {

      // データ上
      board = new Board(null,null,data.board,true);

      if(!data.isOwn) {
        board.extractLegalArea(board.showMoveArea(board));
      }

      // 見かけ上
      updateKomaImg(data.koma,data.moveFrom,data.moveTo,data.isOwn);

      if(data.target){
        setHand(sortHand(board));
      }

      // 手番更新
      teban = data.teban;
    
    });

    // 現在の状態を管理する変数 (1 == 暗転状態)
    let status = 0;

    // 選択中の駒情報
    let komaInfo = null;

    // 盤面クリックで発生するイベント
    $(document).on(clickEventType, ".square", function(){

      if(teban) {
        let toPos = parseInt($(this).attr("id")); // 選択マスのIDを保管

        // 駒を未選択の状態
        if(status == 0) {

          // 自駒をタップした場合
          if($(this).hasClass("isOwn")) {
            komaInfo = board[toPos];                // 駒情報を保管
            $(this).addClass("onTap");              // 選択中フラグを付与
            addBlackOut_SelectArea(komaInfo,toPos); // blackOut、isSelectArea付与
            status = 1;                             // ステータス更新
          }

        // 駒を選択済の状態
        }else if(status == 1) {

          // 移動可能マスの場合 (駒移動処理)
          if($(this).hasClass("selectArea")) {

            // 駒成の判定
            if(!komaInfo.isOu && !komaInfo.isKi && !komaInfo.isEvolve && !komaInfo.isHold){
              if((komaInfo.isSente && game.SenteArea.includes(toPos)) || (komaInfo.isSente && game.SenteArea.includes(komaInfo.position)) || (!komaInfo.isSente && game.GoteArea.includes(toPos)) || (!komaInfo.isSente && game.GoteArea.includes(komaInfo.position))){
                if(!confirm('成りますか？')){
                }else{
                    // OKの時の処理
                    komaInfo.isEvolve = true;
                }
              }
            }

            let socketInfo = {
              roomId:game.roomId,
              board:board,
              komaInfo:komaInfo,
              fromPos:komaInfo.position,
              toPos:toPos
            }

            // サーバーに送信
            socket.emit("moveKoma", socketInfo);

            removeOnTap_SelectArea_BlackOut();     // onTap、selectArea、blackOutを全削除
            status = 0;                            // ステータス更新
          
          // 移動可能マス以外の場合
          } else {

            removeOnTap_SelectArea_BlackOut();     // onTap、selectArea、blackOutを全削除
            status = 0;                            // ステータス更新

            // 選択中の駒と別の駒をタップした場合
            if($(this).hasClass("isOwn") && toPos != komaInfo.position) {
              komaInfo = board[toPos];                // 駒情報を保管
              $(this).addClass("onTap");              // 選択中フラグを付与
              addBlackOut_SelectArea(komaInfo,toPos); // blackOut、isSelectArea付与
              status = 1;                             // ステータス更新
            }
          }
        }
      }
    });

  });
</script>

<div id="content">

  <div class="top">
    <div id="enemy"></div>
    <div class="giveUp"></div>
  </div>

  <div class="boards">
    <img src="/images/parts/outBoard.png" width="100%" height="100%">
    <div class="board">
      <% if(own.id == matchingInfo.sente){ %>
        <% for (var i = 1; i <= 9; i=i+1) { %>
          <% for (var j = 90; j >= 10; j=j-10) { %>
            <% if(boardInfo[i+j] !== undefined){ %>
              <% if(boardInfo[i+j].isOwn){ %>
                <div class="square isOwn" id="<%= i+j %>" name="<%-boardInfo[i+j].koma%>" tap="0">
                  <div></div>
                </div>
              <% }else{ %>
                <div class="square isEnemy" id="<%= i+j %>" name="<%-boardInfo[i+j].koma%>" tap="0">
                  <div></div>
                </div>
              <% } %>
            <% }else{ %> 
              <div class="square" id="<%= i+j %>" name=" " tap="0">
                <div></div>
              </div>
            <% } %>
          <% } %>
        <% } %>
      <% } else { %>
        <% for (var i = 9; i >= 1; i=i-1) { %>
          <% for (var j = 10; j <= 90; j=j+10) { %>
            <% if(boardInfo[i+j] !== undefined){ %>
              <% if(boardInfo[i+j].isOwn){ %>
                <div class="square isOwn" id="<%= i+j %>" name="<%-boardInfo[i+j].koma%>" tap="0">
                  <div></div>
                </div>
              <% }else{ %>
                <div class="square isEnemy" id="<%= i+j %>" name="<%-boardInfo[i+j].koma%>" tap="0">
                  <div></div>
                </div>
              <% } %>
            <% }else{ %> 
              <div class="square" id="<%= i+j %>" name=" " tap="0">
                <div></div>
              </div>
            <% } %>
          <% } %>
        <% } %>
      <% } %>
    </div>
  </div>

  <div class="bottom">
    <div id="own"></div>
  </div>

</div>

<div id="modal-container">
  <div class="modal-background">
    <div class="modal">
      <h2>player<%=matchingInfo.sente%></h2>
      <p>vs</p>
      <h2>player<%=matchingInfo.gote%></h2>
      <p>あなたは<% if(matchingInfo.sente == own.id){ %> 先手です <% }else{ %> 後手です <% } %> </p>
    </div>
  </div>
</div>


<%- include('./common/footer') %>